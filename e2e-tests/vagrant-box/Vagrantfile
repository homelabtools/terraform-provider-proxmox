Vagrant.configure("2") do |config|
  config.vagrant.plugins = ["vagrant-reload"]

  config.vm.box         = "debian/buster64"
  config.vm.box_version = "~> 10.0"

  config.vm.provider "virtualbox" do |v|
    v.memory = 4096  # Required for Proxmox to run properly
    v.cpus = 2
  end

  vbox_version = `VBoxManage --version | awk -F'r' '{print $1}'`.strip

  # Install Proxmox and reboot into the new Proxmox kernel
  config.vm.provision "shell", path: "src/install-proxmox.sh"
  config.vm.provision :reload

  # Caddy is used to strip HTTPS from the Proxmox endpoint which makes debugging easier.
  # Now is no need to mess with importing certs like when MITM'ing HTTPS.
  config.vm.provision "file", source: "src/Caddyfile", destination: "/tmp/Caddyfile"
  config.vm.provision "shell", inline: "mv -f /tmp/Caddyfile /etc/caddy/Caddyfile"

  # Reinstall guest additions for the new kernel
  config.vm.provision "shell", path: "src/install-guest-additions.sh", env: { "VBOX_VERSION": vbox_version }

  # Set up HTTP proxy for mitmweb
  config.vm.provision "shell", inline: "echo HTTP_PROXY=http://127.0.0.1:8080 >> /etc/environment"
  config.vm.provision "shell", inline: "echo HTTPS_PROXY=http://127.0.0.1:8080 >> /etc/environment"
end
