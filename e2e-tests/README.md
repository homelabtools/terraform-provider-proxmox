# End-to-End Test Suite

This directory provides full end-to-end tests of the Proxmox provider. This means verifying functionality by running Terraform against a real instance of Proxmox, then verifying the expected results using the Proxmox API. 

The tests work by spinning up a real instance of Proxmox (running on Debian) inside a VM using Vagrant. The test code has several test fixtures which make it easy to work with Proxmox and Terraform.

Test isolation is provided using VM snapshots. The state of the VM is snapshotted before and after tests are run, providing full isolation and also leaving the post-test state intact for debugging purposes (i.e. SSH into the VM and examine the state of Proxmox).

At the moment, only a sample test case is ready, under `cases/simple`, although the test architecture is fully implemented. A full suite of regression tests is coming soon and will be generated by capturing HTTP traffic from the Provider and using it as the expected output.

## Running Tests

### Prerequisites

* Vagrant
* VirtualBox (or another provider like VMware or libvirt, but the Vagrantfile will need modifications)

Before running the tests, the Proxmox Vagrant box will need to be built. This is ideally done with Packer, but for the time being, using the base box for Debian with Vagrant is simpler than building an entire Debian installation workflow with Packer.

The first test run requires a built of the Proxmox base box.
From the root of the repo:
```sh
$ make e2e-box e2e-test
```

Upon subsequent runs, just run:
```sh
$ make e2e-test
```

## Test Case Definitions
Test cases are defined in the `cases/` directory. Within that, each subdirectory is a separate test case, each containing some Terraform and a JSON file describing the expected results that get returned by the Proxmox API.

It contains `main.tf` which contains some HCL describing resources for the test:
```terraform
resource "proxmox_virtual_environment_role" "example" {
  privileges = [
    "VM.Monitor",
  ]
  role_id = "test-role"
}
```

As well as a JSON file that contains expected API results, `expected.json`:
```json
{
  "access/roles": [
    {
      "special": 0,
      "privs": "VM.Monitor",
      "roleid": "test-role"
    }
  ]
}
```

In this example, `expected.json` is indicating that `https://proxmox/apiv2/json/access/roles` should have a particular JSON object present in its response.

The test fixture type `TerraformTestFixture` will take these test case directories and automatically generate the necessary `provider` and `terraform` blocks. Test cases need only define the resources.

After running `terraform apply`, the test logic inside `TestMain` will call the API `access/roles`, look at the contents of its JSON response, checking `data` contains the objects defined by the JSON. If so, the test is successful, if not, it fails.

# Debugging Tests

First, ensure that you're running tests with `SKIP_CLEANUP=1` to prevent teardown of the VM, otherwise there will be nothing to debug when the tests are done.

## Inspecting HTTP Traffic

The Vagrant VM is running `mitmproxy`, which automatically captures traffic between the provider and Proxmox.

## Debugging with Snapshots
The test setup optionally leverages VM snapshots for debugging -- by taking snapshots at the end of every test case, the user can restore that snapshot once tests are completed and introspect the state of Proxmox to debug their tests.

![Snapshots in VirtualBox](https://i.postimg.cc/nLfbq7xJ/Screen-Shot-2021-08-20-at-1-40-00-PM.png)

To use, run tests with `SKIP_CLEANUP=1 make e2e-test`. This will leave the VM intact at the end of the tests.

Snapshots can be disabled with `DISABLE_SNAPSHOTS=1 make e2e-test`. This is handy for quick development when you don't need the full isolation provided by snapshots.


## Possible Errors That macOS Users May See

When running on macOS with VirtualBox, you may occasionally see an error saying:

```
Received unexpected error:
exit status 1
```

Open up VirtualBox and attempt to start the Vagrant VM by hand. If you see an error about a kernel mode driver not being installed, it's likely because you've updated the OS since the time you installed VirtualBox. To fix it, just reinstall VirtualBox. Be sure to reboot after installation.